{% extends "global/Page.html" %}
{% load otree %}
{% block styles %}
<style type="text/css">
table.lap, td.lap, th.lap {
    border: 1px solid black;
  }
  
  table.lap {
    border-collapse: collapse;
    width: 100%;
    margin-top: 24px;
  }
  
  th.lap {
    font-size: 14px /*0.75vw*/;
    height: 2ex;
    text-align: center;
    background-color: rgb(200, 200, 200);
  }
  
  td.lap {
    font-size: 14px /*0.5vw*/;
    height: 3.5ex;
    text-align: left;
    padding: 24px;
  }
</style>
{% endblock %}
{% block title %}
Pelaporan Pajak Penghasilan
{% endblock %}

{% block content %}
<h5>Periode Inti ke-{{round}}</h5>
<br>
<p>
  Dari penghasilan yang Anda dapatkan dari game sebelumnya Anda diharapkan melaporkan pajak dengan jujur dengan form berikut. Untuk memudahkan, hanya field omset yang perlu Anda isi, untuk field lain akan terisi secara otomatis
</p>
<input id="preview" type="button" class="btn btn-danger" onclick="prevFunction()" value="Preview Omset" />&emsp;&emsp;<span id="prev"></span>

<table class="lap">
    <tr><td class="lap">
    <h5>Pelaporan SPT</h5>
    <br>
    <input type="hidden" id="prefill_persen" name="prefill_persen" />
    <input type="hidden" id="omset_input" name="omset_input" />
    Masukkan omset&emsp;&emsp;&emsp;&emsp;: <input type="text" id="txt_omset_input" name="txt_omset_input" /> EU<br><br>
    Jumlah pajak terutang &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" id="pph" name="pph" disabled /> EU
    <br>
    <br>
    <input type="hidden" id="payoff_awal" name="payoff_awal" />
    Jumlah payoff yang mungkin didapat pada periode ini : <input type="text" id="txt_payoff_awal" name="txt_payoff_awal" disabled /> EU<br>
    </td></tr>
</table>
<br>
<p>Pastikan kembali bahwa pengisian pelaporan pajak benar-benar sesuai dengan keputusan Anda. </p>
<br>
<p>Tekan tombol 'Lanjut' jika Anda sudah yakin dengan isian pelaporan Anda</p>
<button id="btn_lanjut" disabled="disabled" class="otree-btn-next btn btn-primary">Lanjut</button>
<script>

    function hitungFunction() {
      var txt_omset = document.getElementById("txt_omset_input").value;
      var omset_input = parseFloat(txt_omset.replace(/,/g, ''));
        // var omset_input = Number(document.getElementById("omset_input").value)
        var ts = omset_input * {{tarif_pajak}};
        var lr = {{player.total_omset}} - {{player.total_biaya}};
        var payoff = lr - ts;

        document.getElementById("pph").value = thousands_separators(ts)
        document.getElementById("payoff_awal").value = payoff

        if (document.getElementById("txt_omset_input").value == "") {
          document.getElementById("omset_input").value = 0
        } else {
          document.getElementById("omset_input").value = omset_input
        }
        document.getElementById("txt_payoff_awal").value = thousands_separators(payoff)
    }

    function prevFunction() {
      document.getElementById("prev").textContent = thousands_separators({{player.total_omset}}) + " EU"
    }

    function thousands_separators(num)
    {
        var num_parts = num.toString().split(".");
        num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return num_parts.join(".");
    }

    $("#txt_omset_input").keyup(function(event){
        //var oms = str(document.getElementById("omset_input").value).replace(",","")
        // When user select text in the document, also abort.
        var selection = window.getSelection().toString(); 
        if (selection !== '') {
            return; 
        }       
        // When the arrow keys are pressed, abort.
        if ($.inArray(event.keyCode, [38, 40, 37, 39]) !== -1) {
            return; 
        }       
        var $this = $(this);            
        // Get the value.
        var input = $this.val();            
        input = input.replace(/[\D\s\._\-]+/g, ""); 
        input = input?parseInt(input, 10):0; 
        $this.val(function () {
            return (input === 0)?"0":input.toLocaleString("en-US"); 
        });
        hitungFunction();
    });

    //prefilled
    function getRndInteger(min, max) {
      return Math.floor(Math.random() * (max - min)) + min;
    }
    var treatment = Number({{treatment}});

    function getTreat(treatment) {
      var prefilled_persen = 0;
      if (treatment == 1) {
        prefilled_persen = getRndInteger(25,99);
      } else if (treatment == 2) {
        prefilled_persen = 100;
      } else if (treatment == 3) {
        prefilled_persen = getRndInteger(101,175);
      } else {
        prefilled_persen = 0;
      }
      return prefilled_persen;
    }

    if (treatment == 1) {
      prefilled_persen = getRndInteger(25,99);
    } else if (treatment == 2) {
      prefilled_persen = 100;
    } else if (treatment == 3) {
      prefilled_persen = getRndInteger(101,175);
    } else if (treatment == 4) {
      var t = getRndInteger(1,3)
      prefilled_persen = getTreat(t)
    } else {
      prefilled_persen = 0;
    }

    document.getElementById("prefill_persen").value = prefilled_persen;
    document.getElementById("txt_omset_input").value = prefilled_persen / 100 * {{player.total_omset}};
    $("#txt_omset_input").keyup();

    var s = 10;

    // Update the count down every 1 second
    var x = setInterval(function() {
      
      // If the count down is over, write some text 
      if (s <= 0) {
        clearInterval(x);
        document.getElementById('btn_lanjut').disabled = false;
        document.getElementById("btn_lanjut").textContent = "Lanjut"
      } else {
        document.getElementById("btn_lanjut").textContent = "Lanjut ("+s+")";
      }
      s--;
    }, 1000);

</script>
{% endblock %}